<%- include('layouts/app') -%>

<div class="container pb-5">
    <!-- Статистика МКС -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="space-stats card-stats">
                <div class="stats-icon">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-value" id="iss-speed">
                        <% if (iss.payload && iss.payload.velocity) { %>
                            <%= new Intl.NumberFormat('ru-RU').format(Math.round(iss.payload.velocity)) %>
                        <% } else { %>—<% } %>
                    </div>
                    <div class="stats-label">Скорость МКС</div>
                    <div class="stats-unit">км/ч</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="space-stats card-stats">
                <div class="stats-icon">
                    <i class="fas fa-mountain"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-value" id="iss-altitude">
                        <% if (iss.payload && iss.payload.altitude) { %>
                            <%= new Intl.NumberFormat('ru-RU').format(Math.round(iss.payload.altitude)) %>
                        <% } else { %>—<% } %>
                    </div>
                    <div class="stats-label">Высота МКС</div>
                    <div class="stats-unit">км</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="space-stats card-stats">
                <div class="stats-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-value" id="iss-lat">
                        <% if (iss.payload && iss.payload.latitude) { %>
                            <%= iss.payload.latitude.toFixed(4) %>°
                        <% } else { %>—<% } %>
                    </div>
                    <div class="stats-label">Широта</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="space-stats card-stats">
                <div class="stats-icon">
                    <i class="fas fa-longitude"></i>
                </div>
                <div class="stats-content">
                    <div class="stats-value" id="iss-lon">
                        <% if (iss.payload && iss.payload.longitude) { %>
                            <%= iss.payload.longitude.toFixed(4) %>°
                        <% } else { %>—<% } %>
                    </div>
                    <div class="stats-label">Долгота</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Блок МКС с картой и графиками -->
    <div class="card space-card mb-4">
        <div class="card-header space-card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title m-0">
                    <i class="fas fa-satellite me-2"></i>Международная Космическая Станция
                </h5>
                <div class="d-flex align-items-center">
                    <span class="badge bg-space-teal pulse-animation me-3">
                        <i class="fas fa-satellite me-1"></i>LIVE
                    </span>
                    <button class="btn btn-space-outline btn-sm" id="refreshIss">
                        <i class="fas fa-sync-alt me-1"></i>Обновить
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Карта -->
                <div class="col-lg-7">
                    <div class="space-map-container">
                        <div id="map" class="space-map"></div>
                    </div>
                </div>

                <!-- Графики -->
                <div class="col-lg-5">
                    <div class="chart-wrapper">
                        <div class="chart-card">
                            <div class="chart-header">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                <span>История скорости</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="speedChart" height="200"></canvas>
                            </div>
                        </div>

                        <div class="chart-card mt-3">
                            <div class="chart-header">
                                <i class="fas fa-mountain me-2"></i>
                                <span>История высоты</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="altChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Информация о траектории -->
            <div class="mt-3 pt-3 border-top border-space-dark">
                <div class="row">
                    <div class="col-md-6">
                        <div class="trajectory-info">
                            <div class="info-row">
                                <span class="info-label">Обновлено:</span>
                                <span class="info-value" id="iss-updated">
                                    <% if (iss.fetched_at) { %>
                                        <%= iss.fetched_at %>
                                    <% } else { %>
                                        <%= new Date().toLocaleTimeString() %>
                                    <% } %>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Статус:</span>
                                <span class="info-value text-space-teal">
                                    <i class="fas fa-circle me-1"></i>Активный
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-space-light">
                            Данные обновляются каждые 15 секунд
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Галерея JWST -->
    <div class="card space-card">
        <div class="card-header space-card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title m-0">
                    <i class="fas fa-satellite-dish me-2"></i>Космический телескоп JWST
                </h5>
                <form id="jwstFilter" class="row g-2 align-items-center">
                    <div class="col-auto">
                        <select class="form-select form-space form-select-sm" name="source" id="srcSel">
                            <option value="jpg" selected>Все изображения</option>
                            <option value="suffix">По суффиксу</option>
                            <option value="program">По программе</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" class="form-control form-space form-control-sm"
                               name="suffix" id="suffixInp" placeholder="_cal" style="width:120px;display:none">
                        <input type="text" class="form-control form-space form-control-sm"
                               name="program" id="progInp" placeholder="№ программы" style="width:110px;display:none">
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-space form-select-sm" name="instrument">
                            <option value="">Все инструменты</option>
                            <option>NIRCam</option><option>MIRI</option><option>NIRISS</option><option>NIRSpec</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-space-primary btn-sm" type="submit">
                            <i class="fas fa-search me-1"></i>Применить
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="card-body">
            <!-- Галерея -->
            <div class="gallery-wrapper">
                <div class="gallery-track" id="jwstTrack">
                    <% if (jwstGallery && jwstGallery.length > 0) { %>
                        <% jwstGallery.forEach((item, index) => { %>
                            <div class="gallery-item">
                                <div class="image-container">
                                    <a href="<%= item.link || item.url %>"
                                       target="_blank"
                                       class="image-link">
                                        <img src="<%= item.url %>"
                                             alt="JWST"
                                             class="gallery-img"
                                             loading="lazy">
                                        <div class="image-hover">
                                            <i class="fas fa-expand"></i>
                                        </div>
                                    </a>
                                    <% if (item.inst && item.inst.length > 0) { %>
                                        <div class="image-tags">
                                    <span class="tag tag-teal">
                                        <%= item.inst[0] %>
                                    </span>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="image-caption">
                                    <%= item.caption.replace(/</g, '&lt;') %>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="gallery-empty">
                            <div class="space-spinner"></div>
                            <p class="text-space-light mt-2">Загрузка изображений...</p>
                        </div>
                    <% } %>
                </div>

                <!-- Навигация -->
                <button class="gallery-nav gallery-prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="gallery-nav gallery-next">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Информация о галерее -->
            <div class="gallery-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="gallery-stats">
                        <span class="badge-space">
                            <i class="fas fa-images me-1"></i>
                            <span id="jwstCount"><%= jwstGallery ? jwstGallery.length : 0 %></span> изображений
                        </span>
                        <span class="text-space-light ms-3">NASA JWST</span>
                    </div>
                    <div class="gallery-info" id="jwstInfo"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ====== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ======
        let map = null;
        let marker = null;
        let trail = null;
        let speedChart = null;
        let altChart = null;

        // История для графиков
        window.issHistory = {
            speeds: [],
            altitudes: [],
            times: []
        };

        // ====== ИНИЦИАЛИЗАЦИЯ КАРТЫ ======
        function initMap() {
            const last = <%- JSON.stringify(iss.payload || {}) %>;
            const lat = Number(last.latitude || 55.7558);
            const lon = Number(last.longitude || 37.6176);

            // Инициализация карты
            if (typeof L !== 'undefined') {
                map = L.map('map').setView([lat, lon], lat ? 3 : 2);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                // Маркер МКС
                marker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: '<div class="iss-marker"><i class="fas fa-satellite"></i></div>',
                        iconSize: [30, 30],
                        className: 'iss-marker-icon'
                    })
                }).addTo(map);

                // Траектория
                trail = L.polyline([], {
                    color: '#00bcd4',
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);
            }
        }

        // ====== ИНИЦИАЛИЗАЦИЯ ГРАФИКОВ ======
        function initCharts() {
            if (typeof Chart === 'undefined') return;

            // Конфигурация для обоих графиков
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(10, 17, 40, 0.9)',
                        titleColor: '#00bcd4',
                        bodyColor: '#e3f2fd',
                        borderColor: '#00bcd4',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(0, 188, 212, 0.1)' },
                        ticks: { color: 'rgba(227, 242, 253, 0.7)', maxTicksLimit: 8 }
                    },
                    y: {
                        grid: { color: 'rgba(0, 188, 212, 0.1)' },
                        ticks: { color: 'rgba(227, 242, 253, 0.7)' }
                    }
                },
                elements: {
                    line: {
                        tension: 0.4,
                        borderWidth: 2
                    },
                    point: {
                        radius: 3,
                        hoverRadius: 6,
                        backgroundColor: 'rgba(0, 188, 212, 0.8)'
                    }
                }
            };

            // График скорости
            const speedCtx = document.getElementById('speedChart');
            if (speedCtx) {
                speedChart = new Chart(speedCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Скорость (км/ч)',
                            data: [],
                            borderColor: '#00bcd4',
                            backgroundColor: 'rgba(0, 188, 212, 0.1)',
                            fill: true
                        }]
                    },
                    options: chartConfig
                });
            }

            // График высоты
            const altCtx = document.getElementById('altChart');
            if (altCtx) {
                altChart = new Chart(altCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Высота (км)',
                            data: [],
                            borderColor: '#e91e63',
                            backgroundColor: 'rgba(233, 30, 99, 0.1)',
                            fill: true
                        }]
                    },
                    options: chartConfig
                });
            }
        }

        // ====== ЗАГРУЗКА ДАННЫХ МКС ======
        async function loadISSData() {
            try {
                const response = await fetch('/api/iss/last');
                const data = await response.json();

                if (data.payload) {
                    const { latitude, longitude, velocity, altitude } = data.payload;

                    // Обновление метрик
                    document.getElementById('iss-speed').textContent =
                        Number(velocity).toLocaleString('ru-RU') + ' км/ч';
                    document.getElementById('iss-altitude').textContent =
                        Number(altitude).toLocaleString('ru-RU') + ' км';
                    document.getElementById('iss-lat').textContent =
                        Number(latitude).toFixed(4) + '°';
                    document.getElementById('iss-lon').textContent =
                        Number(longitude).toFixed(4) + '°';

                    // Обновление карты
                    if (marker) {
                        marker.setLatLng([latitude, longitude]);
                        marker.bindPopup(`МКС<br>Скорость: ${velocity} км/ч<br>Высота: ${altitude} км`);
                    }
                    if (map) {
                        map.setView([latitude, longitude], map.getZoom() || 3);
                    }

                    // Загрузка тренда для трека
                    const trendResponse = await fetch('/api/iss/trend?limit=100');
                    const trendData = await trendResponse.json();

                    // Обновление трека на карте
                    if (trendData && trail) {
                        if (trendData.from_lat && trendData.from_lon && trendData.to_lat && trendData.to_lon) {
                            const points = [
                                [trendData.from_lat, trendData.from_lon],
                                [trendData.to_lat, trendData.to_lon]
                            ];
                            trail.setLatLngs(points);
                        }
                    }

                    // Обновление графиков с текущей скоростью и высотой
                    if (velocity && altitude && speedChart && altChart) {
                        const now = new Date().toLocaleTimeString('ru-RU', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        window.issHistory.speeds.push(parseFloat(velocity));
                        window.issHistory.altitudes.push(parseFloat(altitude));
                        window.issHistory.times.push(now);

                        // Оставляем только последние 20 точек
                        if (window.issHistory.speeds.length > 20) {
                            window.issHistory.speeds.shift();
                            window.issHistory.altitudes.shift();
                            window.issHistory.times.shift();
                        }

                        // Обновление графиков
                        speedChart.data.labels = window.issHistory.times;
                        speedChart.data.datasets[0].data = window.issHistory.speeds;
                        speedChart.update('none');

                        altChart.data.labels = window.issHistory.times;
                        altChart.data.datasets[0].data = window.issHistory.altitudes;
                        altChart.update('none');
                    }

                    // Обновление времени
                    document.getElementById('iss-updated').textContent =
                        data.fetched_at || new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Ошибка загрузки данных МКС:', error);
            }
        }

        // ====== ГАЛЕРЕЯ JWST ======
        function initGallery() {
            const track = document.getElementById('jwstTrack');
            const prevBtn = document.querySelector('.gallery-prev');
            const nextBtn = document.querySelector('.gallery-next');
            const form = document.getElementById('jwstFilter');
            const srcSel = document.getElementById('srcSel');
            const sfxInp = document.getElementById('suffixInp');
            const progInp = document.getElementById('progInp');

            // Переключение полей ввода
            function toggleInputs() {
                sfxInp.style.display = (srcSel.value === 'suffix') ? 'inline-block' : 'none';
                progInp.style.display = (srcSel.value === 'program') ? 'inline-block' : 'none';
            }

            srcSel.addEventListener('change', toggleInputs);
            toggleInputs();

            // Навигация галереи
            if (prevBtn && nextBtn && track) {
                prevBtn.addEventListener('click', () => {
                    track.scrollBy({ left: -300, behavior: 'smooth' });
                });

                nextBtn.addEventListener('click', () => {
                    track.scrollBy({ left: 300, behavior: 'smooth' });
                });
            }

            // Фильтрация
            if (form) {
                form.addEventListener('submit', async function(ev) {
                    ev.preventDefault();

                    const fd = new FormData(form);
                    const q = Object.fromEntries(fd.entries());

                    try {
                        const track = document.getElementById('jwstTrack');
                        const info = document.getElementById('jwstInfo');

                        track.innerHTML = '<div class="gallery-empty"><div class="space-spinner"></div><p>Загрузка...</p></div>';
                        info.textContent = '';

                        const url = '/api/jwst/feed?' + new URLSearchParams(q).toString();
                        const r = await fetch(url);
                        const js = await r.json();

                        track.innerHTML = '';

                        if (js.items && Array.isArray(js.items)) {
                            js.items.forEach(it => {
                                const item = document.createElement('div');
                                item.className = 'gallery-item';
                                item.innerHTML = `
                                <div class="image-container">
                                    <a href="${it.link || it.url}" target="_blank" class="image-link">
                                        <img loading="lazy" src="${it.url}" alt="JWST" class="gallery-img">
                                        <div class="image-hover">
                                            <i class="fas fa-expand"></i>
                                        </div>
                                    </a>
                                    ${it.inst && it.inst.length > 0 ?
                                    `<div class="image-tags">
                                            <span class="tag tag-teal">${it.inst[0]}</span>
                                        </div>` : ''}
                                </div>
                                <div class="image-caption">${(it.caption || '').replace(/</g, '&lt;')}</div>
                            `;
                                track.appendChild(item);
                            });

                            document.getElementById('jwstCount').textContent = js.items.length;
                            info.textContent = `Показано ${js.items.length} изображений`;
                        }
                    } catch(e) {
                        console.error('Ошибка загрузки JWST:', e);
                        document.getElementById('jwstTrack').innerHTML =
                            '<div class="gallery-empty"><p class="text-danger">Ошибка загрузки</p></div>';
                    }
                });
            }
        }

        // ====== ИНИЦИАЛИЗАЦИЯ ======
        function init() {
            initMap();
            initCharts();
            initGallery();

            // Первоначальная загрузка данных
            loadISSData();

            // Кнопка обновления
            document.getElementById('refreshIss')?.addEventListener('click', loadISSData);

            // Автообновление каждые 15 секунд
            setInterval(loadISSData, 15000);
        }

        // Запуск
        init();
    });
</script>
